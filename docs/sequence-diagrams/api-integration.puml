@startuml

participant "Node" as Node order 5
participant "EnactTrust\nFrontEnd" as FE order 10
participant "EnactTrust\nBackEnd" as BE order 20
database "EnactTrust\nBackend DB" as BE_DB order 30
participant "Veraison\nEvidence\nVerification" as V_EviVfy order 35
participant "Veraison\nEndorsements\nProvisioning" as V_EndProv order 40
database "Veraison\nEndorsement Store" as V_EndStore order 50

group keys provisioning and Node ID assignment

	Node -> BE: POST /node/pem, Body: {nodeID, AK_pub, EK_pub}
	BE -> BE: generate nodeID
	BE -> BE_DB: store nodeID AK_pub and EK_pub
	BE -> BE: repackage {nodeID, AK_pub} as CoRIM
	BE -> V_EndProv: POST /submit, Body: CoRIM{nodeID, AK_pub}
	V_EndProv -> V_EndStore: nodeID=>{AK_pub}
	V_EndProv -> BE: Status: 200
	BE -> Node: Status: 201, Body: {nodeID}
end

group golden values provisioning
	Node -> BE: POST /node/secret, Body: {nodeID}
	BE -> V_EviVfy: POST /newSession
	V_EviVfy -> V_EviVfy: /session/123=>{"nonce"="the-challenge", ...}
	V_EviVfy -> BE: Status: 201, Location: /session/123, Body: {"nonce"="the-challenge", ...}
	BE -> BE: Encrypt(EK_pub, "the-challenge") -> N
	BE -> Node: Status: 200, Body: {N}

	Node -> Node: Decrypt(EK_priv, N) -> "the-challenge"
	Node -> Node: TPM2_Quote("the-challenge", PCR23) -> golden
	Node -> BE: POST /node/golden, Body: {nodeID, golden}
	BE -> BE: repackage {nodeID, golden} as CoRIM with vnd.enacttrust.tpm-evidence payload
	BE -> V_EviVfy: POST /session/123, Body: CoRIM{vnd.enacttrust.tpm-evidence}
	V_EviVfy -> V_EviVfy: CoRIM{TPMS_ATTEST.extraData} -> nodeID
	V_EviVfy -> V_EndStore: lookupKeys(nodeID)
	V_EndStore -> V_EviVfy: AK_pub
	V_EviVfy -> V_EviVfy: CoRIM{TPMS_ATTEST, TPMT_SIGNATURE} -> TPM_evidence
	V_EviVfy -> V_EviVfy: Verify(AK_pub, TPM_evidence) for identity and data integrity
	V_EviVfy -> V_EviVfy: Verify("the-challenge")) to confirm a geniune golden value
	alt verification successful
		V_EviVfy -> BE: Status: 200, Body: {"state": "complete", "results": "success"}
		BE -> V_EndProv: POST /submit, Body: CoRIM{vnd.enacttrust.tpm-evidence}
		V_EndProv -> V_EndStore: nodeID=>{golden}
		V_EndProv -> BE: Status: 200
		BE -> FE: Status: 200
	else verification failed
		V_EviVfy -> BE: Status: 200, Body: {"state": "complete", "results": "failure"}
		BE -> FE: Status: 500
	end
	BE -> BE_DB: update node state
end

group periodic evidence submission
	Node -> BE: POST /node/secret, Body: {nodeID}
	BE -> V_EviVfy: POST /newSession
	V_EviVfy -> V_EviVfy: /session/456=>{"nonce"="another-challenge", ...}
	V_EviVfy -> BE: Status: 201, Location: /session/456, Body: {"nonce"="another-challenge", ...}
	BE -> BE: Encrypt(EK_pub, "another-challenge") -> N
	BE -> Node: Status: 200, Body: {N}

	Node -> Node: Decrypt(EK_priv, N) -> "another-challenge"
	Node -> Node: TPM2_Quote("another-challenge", PCR23) -> evidence
	Node -> BE: POST /node/evidence, Body: {nodeID, TPMS_ATTEST("another-challenge", evidence)}
	BE -> BE: repackage {nodeID, golden} as CoRIM with vnd.enacttrust.tpm-evidence payload
	BE -> V_EviVfy: POST /session/456, Body: CoRIM{vnd.enacttrust.tpm-evidence}
	V_EviVfy -> V_EviVfy: CoRIM{TPMS_ATTEST.extraData} -> nodeID
	V_EviVfy -> V_EndStore: lookupKeys(nodeID)
	V_EndStore -> V_EviVfy: AK_pub
	V_EviVfy -> V_EviVfy: CoRIM{TPMS_ATTEST, TPMT_SIGNATURE} -> TPM_evidence
	V_EviVfy -> V_EviVfy: Verify(AK_pub, TPM_evidence)) for identity and data integrity
	V_EviVfy -> V_EviVfy: Verify("the-challenge")) to mitigate MITM attacks
	alt verification successful
		V_EviVfy -> BE: Status: 200, Body: {"state": "complete", "results": "success"}
		BE -> Node: Status: 200
	else verification failed
		V_EviVfy -> BE: Status: 200, Body: {"state": "complete", "results": "failure"}
		BE -> Node: Status: 500
	end
	BE -> BE_DB: update node state
end

@enduml
